name: Update Sing-box Subscription

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°é…ç½®æ–‡ä»¶'
        required: false
        default: 'false'
        type: boolean
      custom_message:
        description: 'è‡ªå®šä¹‰æäº¤æ¶ˆæ¯'
        required: false
        default: 'Auto update subscription config'
        type: string
  
  # å®šæ—¶è§¦å‘ (æ¯å¤© UTC æ—¶é—´ 02:00ï¼Œå³åŒ—äº¬æ—¶é—´ 10:00)
  schedule:
    - cron: '0 2 * * *'
  
  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ (å¯é€‰)
  push:
    branches: [ main ]
    paths:
      - 'url.yaml'
      - 'config.json'
      - 'convert_subscription.py'

# å·¥ä½œæµä»»åŠ¡
jobs:
  update-subscription:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # è®¾ç½® Python çŽ¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    # å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # å¤‡ä»½çŽ°æœ‰é…ç½®æ–‡ä»¶
    - name: Backup existing configs
      run: |
        if [ -f "sing-box_config.json" ]; then
          cp sing-box_config.json sing-box_config.json.backup
        fi
        if [ -f "sing-box.json" ]; then
          cp sing-box.json sing-box.json.backup
        fi
    
    # è¿è¡Œè®¢é˜…è½¬æ¢
    - name: Run subscription converter
      run: |
        echo "å¼€å§‹è½¬æ¢è®¢é˜…..."
        python convert_subscription.py
        echo "è½¬æ¢å®Œæˆï¼"
    
    # éªŒè¯ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
    - name: Validate generated configs
      run: |
        if [ ! -f "sing-box_config.json" ]; then
          echo "é”™è¯¯ï¼šæœªç”Ÿæˆé…ç½®æ–‡ä»¶"
          exit 1
        fi
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON
        python -c "import json; json.load(open('sing-box_config.json'))"
        echo "é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"
        
        # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        echo "=== é…ç½®ç»Ÿè®¡ ==="
        if [ -f "sing-box.json" ]; then
          PROXY_COUNT=$(python -c "import json; data=json.load(open('sing-box.json')); print(len(data))")
          echo "ä»£ç†èŠ‚ç‚¹æ•°é‡: $PROXY_COUNT"
        fi
    
    # æ£€æŸ¥æ–‡ä»¶å˜åŒ–
    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet HEAD -- sing-box_config.json sing-box.json; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜åŒ–"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜åŒ–"
        fi
    
    # æäº¤æ›´æ”¹
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true'
      run: |
        # é…ç½® Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ–‡ä»¶
        git add sing-box_config.json sing-box.json
        
        # å‡†å¤‡æäº¤æ¶ˆæ¯
        if [ "${{ github.event.inputs.custom_message }}" != "" ]; then
          COMMIT_MSG="${{ github.event.inputs.custom_message }}"
        else
          COMMIT_MSG="ðŸ¤– Auto update subscription config $(date '+%Y-%m-%d %H:%M:%S UTC')"
        fi
        
        # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯åˆ°æäº¤æ¶ˆæ¯
        if [ -f "sing-box.json" ]; then
          PROXY_COUNT=$(python -c "import json; data=json.load(open('sing-box.json')); print(len(data))")
          COMMIT_MSG="$COMMIT_MSG\n\nðŸ“Š ä»£ç†èŠ‚ç‚¹: $PROXY_COUNT ä¸ª"
        fi
        
        # æäº¤æ›´æ”¹
        git commit -m "$COMMIT_MSG"
        git push
        
        echo "âœ… é…ç½®æ–‡ä»¶å·²æ›´æ–°å¹¶æŽ¨é€åˆ°ä»“åº“"
    
    # æ¸…ç†å¤‡ä»½æ–‡ä»¶
    - name: Cleanup backup files
      if: always()
      run: |
        rm -f sing-box_config.json.backup
        rm -f sing-box.json.backup
    
    # è¾“å‡ºæ‘˜è¦
    - name: Job summary
      if: always()
      run: |
        echo "## ðŸ”„ è®¢é˜…æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "sing-box.json" ]; then
          PROXY_COUNT=$(python -c "import json; data=json.load(open('sing-box.json')); print(len(data))")
          echo "**ä»£ç†èŠ‚ç‚¹æ•°é‡**: $PROXY_COUNT" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo "**çŠ¶æ€**: âœ… é…ç½®å·²æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        else
          echo "**çŠ¶æ€**: â„¹ï¸ æ— å˜åŒ–" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- \`sing-box_config.json\` - å®Œæ•´çš„ sing-box é…ç½®æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- \`sing-box.json\` - ä»£ç†èŠ‚ç‚¹åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY